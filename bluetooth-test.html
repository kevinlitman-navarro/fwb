<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Bluetooth Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .device-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .value-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîµ Arduino Bluetooth Test</h1>
        <p>This page tests Web Bluetooth connection to your Arduino Dial device.</p>
        
        <!-- Browser Compatibility Check -->
        <div id="compatibilityStatus"></div>
        
        <!-- Connection Controls -->
        <div>
            <button id="scanBtn" onclick="scanForDevice()">üîç Scan for Arduino Dial</button>
            <button id="connectBtn" onclick="connectToDevice()" disabled>üîó Connect</button>
            <button id="disconnectBtn" onclick="disconnectDevice()" disabled>‚ùå Disconnect</button>
        </div>
        
        <!-- Status Display -->
        <div id="statusDisplay"></div>
        
        <!-- Device Information -->
        <div id="deviceInfo" style="display: none;"></div>
        
        <!-- Live Values -->
        <div id="valueDisplay" style="display: none;">
            <h3>üìä Live Values</h3>
            <div class="value-display">
                Position: <span id="positionValue">--</span><br>
                <small>Click Status: <span id="clickValue">--</span></small>
            </div>
        </div>
        
        <!-- Debug Log -->
        <h3>üêõ Debug Log</h3>
        <div id="debugLog" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        // Arduino BLE Service UUIDs (matching arduino code)
        const DIAL_SERVICE_UUID = '12345678-1234-1234-1234-123456789abc';
        const POSITION_CHAR_UUID = '12345678-1234-1234-1234-123456789abd';
        const CLICK_CHAR_UUID = '12345678-1234-1234-1234-123456789abe';
        
        let device = null;
        let server = null;
        let service = null;
        let positionCharacteristic = null;
        let clickCharacteristic = null;
        
        // Check browser compatibility
        function checkCompatibility() {
            const statusDiv = document.getElementById('compatibilityStatus');
            
            if (!navigator.bluetooth) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå Web Bluetooth not supported in this browser.<br>
                        <strong>Requirements:</strong> Chrome 56+, Edge 79+, Opera 43+, HTTPS required
                    </div>`;
                return false;
            }
            
            // Check if we're on HTTPS
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            if (!isHTTPS) {
                statusDiv.innerHTML = `
                    <div class="status warning">
                        ‚ö†Ô∏è HTTPS required for Web Bluetooth API.<br>
                        Current protocol: ${location.protocol}<br>
                        <strong>Try:</strong> Use localhost or enable HTTPS
                    </div>`;
            } else {
                statusDiv.innerHTML = `
                    <div class="status success">
                        ‚úÖ Web Bluetooth supported! Ready to connect.
                    </div>`;
            }
            
            return true;
        }
        
        function log(message) {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusDisplay');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        async function scanForDevice() {
            log('Starting Bluetooth device scan...');
            updateStatus('üîç Scanning for Arduino Dial...', 'info');
            
            try {
                log('Requesting device with filters...');
                log(`Service UUID: ${DIAL_SERVICE_UUID}`);
                
                // Request device with specific service UUID
                device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { name: 'Arduino Dial' },
                        { services: [DIAL_SERVICE_UUID] }
                    ],
                    optionalServices: [DIAL_SERVICE_UUID]
                });
                
                log(`Device found: ${device.name} (${device.id})`);
                updateStatus(`‚úÖ Found device: "${device.name}"`, 'success');
                
                // Show device info
                document.getElementById('deviceInfo').style.display = 'block';
                document.getElementById('deviceInfo').innerHTML = `
                    <div class="device-info">
                        <h3>üì± Device Information</h3>
                        <p><strong>Name:</strong> ${device.name}</p>
                        <p><strong>ID:</strong> ${device.id}</p>
                        <p><strong>Connected:</strong> ${device.gatt.connected ? 'Yes' : 'No'}</p>
                    </div>`;
                
                // Enable connect button
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('scanBtn').disabled = true;
                
            } catch (error) {
                log(`Scan failed: ${error.message}`);
                updateStatus(`‚ùå Scan failed: ${error.message}`, 'error');
                
                if (error.message.includes('User cancelled')) {
                    log('User cancelled device selection');
                } else if (error.message.includes('No devices found')) {
                    log('No matching devices found - check if Arduino is advertising');
                    updateStatus('‚ùå No "Arduino Dial" devices found. Check if Arduino is running and advertising.', 'error');
                }
            }
        }
        
        async function connectToDevice() {
            if (!device) {
                log('No device selected');
                return;
            }
            
            log('Connecting to GATT server...');
            updateStatus('üîó Connecting to device...', 'info');
            
            try {
                // Connect to GATT server
                server = await device.gatt.connect();
                log('Connected to GATT server');
                
                // Get primary service
                log(`Getting service: ${DIAL_SERVICE_UUID}`);
                service = await server.getPrimaryService(DIAL_SERVICE_UUID);
                log('Service obtained');
                
                // Get characteristics
                log(`Getting position characteristic: ${POSITION_CHAR_UUID}`);
                positionCharacteristic = await service.getCharacteristic(POSITION_CHAR_UUID);
                log('Position characteristic obtained');
                
                log(`Getting click characteristic: ${CLICK_CHAR_UUID}`);
                clickCharacteristic = await service.getCharacteristic(CLICK_CHAR_UUID);
                log('Click characteristic obtained');
                
                // Start notifications
                log('Starting notifications for position...');
                await positionCharacteristic.startNotifications();
                positionCharacteristic.addEventListener('characteristicvaluechanged', handlePositionChange);
                
                log('Starting notifications for click...');
                await clickCharacteristic.startNotifications();
                clickCharacteristic.addEventListener('characteristicvaluechanged', handleClickChange);
                
                log('‚úÖ Successfully connected and subscribed to notifications!');
                updateStatus('‚úÖ Connected! Turn the dial to see values.', 'success');
                
                // Update UI
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('valueDisplay').style.display = 'block';
                
                // Read initial values
                const initialPosition = await positionCharacteristic.readValue();
                const position = initialPosition.getInt32(0, true);
                document.getElementById('positionValue').textContent = position;
                
            } catch (error) {
                log(`Connection failed: ${error.message}`);
                updateStatus(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }
        
        function handlePositionChange(event) {
            const position = event.target.value.getInt32(0, true);
            document.getElementById('positionValue').textContent = position;
            log(`Position changed: ${position}`);
        }
        
        function handleClickChange(event) {
            const clicked = event.target.value.getUint8(0) === 1;
            document.getElementById('clickValue').textContent = clicked ? 'CLICKED' : 'Released';
            if (clicked) {
                log('Click detected!');
            }
        }
        
        async function disconnectDevice() {
            if (server && server.connected) {
                log('Disconnecting...');
                server.disconnect();
                updateStatus('‚ùå Disconnected', 'info');
            }
            
            // Reset UI
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('valueDisplay').style.display = 'none';
            document.getElementById('deviceInfo').style.display = 'none';
            
            // Clear variables
            device = null;
            server = null;
            service = null;
            positionCharacteristic = null;
            clickCharacteristic = null;
            
            log('Disconnected and reset');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkCompatibility();
            log('Bluetooth test page loaded');
            log('Arduino should be advertising as "Arduino Dial"');
            log('Click "Scan for Arduino Dial" to start');
        });
        
        // Handle disconnection events
        document.addEventListener('gattserverdisconnected', function() {
            log('Device disconnected unexpectedly');
            disconnectDevice();
        });
    </script>
</body>
</html>